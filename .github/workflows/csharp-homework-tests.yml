name: C# Homework Tests

on:
  pull_request:
    paths:
      - 'homeworks/csharp-fundamentals/**/submissions/**'

permissions:
  contents: read
  pull-requests: write

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  validate-and-test:
    runs-on: ubuntu-latest
    name: Validate & Test C# Submissions
    outputs:
      test-results: ${{ steps.run-tests.outputs.results }}
      all-passed: ${{ steps.run-tests.outputs.all_passed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Find Changed Files
        id: changed-files
        uses: tj-actions/changed-files@v42
        with:
          files: |
            homeworks/csharp-fundamentals/**/submissions/*.cs

      - name: Validate File Names
        id: validate-files
        if: steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "ğŸ“‹ Dosya AdÄ± KontrolÃ¼"
          echo "===================="
          
          VALID=true
          INVALID_FILES=""
          
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            filename=$(basename "$file")
            echo "Kontrol ediliyor: $filename"
            
            # Check format: ProblemX_123456789.cs
            if [[ ! $filename =~ ^Problem[1-4]_[0-9]{9}\.cs$ ]]; then
              echo "âŒ HATA: $filename formatÄ± yanlÄ±ÅŸ!"
              echo "   Beklenen: ProblemX_OGRENCI_NO.cs (9 haneli numara)"
              INVALID_FILES="${INVALID_FILES}${filename}\n"
              VALID=false
            else
              echo "âœ… Format doÄŸru: $filename"
            fi
          done
          
          if [ "$VALID" = false ]; then
            echo ""
            echo "âš ï¸ BazÄ± dosya adlarÄ± yanlÄ±ÅŸ formatta!"
            echo "invalid_files<<EOF" >> $GITHUB_OUTPUT
            echo -e "$INVALID_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo ""
          echo "âœ… TÃ¼m dosya adlarÄ± doÄŸru formatta!"
          echo "valid=true" >> $GITHUB_OUTPUT

      - name: Run All Tests
        id: run-tests
        if: steps.changed-files.outputs.any_changed == 'true' && steps.validate-files.outputs.valid == 'true'
        run: |
          echo "ğŸ§ª Testler BaÅŸlÄ±yor"
          echo "==================="
          
          # Initialize results JSON
          RESULTS='{"problems":[],"total_score":0,"max_score":100,"all_passed":true}'
          ALL_PASSED=true
          TOTAL_SCORE=0
          
          # Process each problem
          for problem_num in 1 2 3 4; do
            PROBLEM_DIR="homeworks/csharp-fundamentals/problem-${problem_num}"
            
            if [ -d "$PROBLEM_DIR/submissions" ]; then
              for file in $PROBLEM_DIR/submissions/Problem${problem_num}_*.cs; do
                if [ -f "$file" ]; then
                  filename=$(basename "$file")
                  student_no=$(echo "$filename" | grep -oP 'Problem[1-4]_\K\d{9}')
                  
                  echo ""
                  echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                  echo "â•‘  Problem $problem_num - $filename"
                  echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  
                  # Create temp project
                  TEMP_DIR=$(mktemp -d)
                  cp "$file" "$TEMP_DIR/Problem${problem_num}.cs"
                  cp "$PROBLEM_DIR/Problem${problem_num}.Tests.cs" "$TEMP_DIR/"
                  
                  cd "$TEMP_DIR"
                  dotnet new console -n TestProject -o . --force > /dev/null 2>&1
                  
                  # Run tests and capture output
                  TEST_OUTPUT=$(dotnet run -- "$filename" 2>&1) || true
                  TEST_EXIT_CODE=$?
                  
                  echo "$TEST_OUTPUT"
                  
                  # Parse score from output
                  SCORE=$(echo "$TEST_OUTPUT" | grep -oP 'TOPLAM PUAN\s*â”‚\s*\K[\d.]+' || echo "0")
                  
                  if [ "$TEST_EXIT_CODE" -ne 0 ]; then
                    ALL_PASSED=false
                  fi
                  
                  TOTAL_SCORE=$(echo "$TOTAL_SCORE + $SCORE" | bc)
                  
                  cd - > /dev/null
                  rm -rf "$TEMP_DIR"
                fi
              done
            fi
          done
          
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š TOPLAM SONUÃ‡: $TOTAL_SCORE / 100 puan"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
          # Set outputs
          echo "total_score=$TOTAL_SCORE" >> $GITHUB_OUTPUT
          echo "all_passed=$ALL_PASSED" >> $GITHUB_OUTPUT
          
          # Exit with error if tests failed
          if [ "$ALL_PASSED" = false ]; then
            exit 1
          fi

      - name: Generate Job Summary
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        run: |
          echo "## ğŸ“Š C# Ã–dev Test SonuÃ§larÄ±" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.validate-files.outputs.valid }}" = "false" ]; then
            echo "### âŒ Dosya AdÄ± HatasÄ±" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "AÅŸaÄŸÄ±daki dosyalarÄ±n adlarÄ± yanlÄ±ÅŸ formatta:" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.validate-files.outputs.invalid_files }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Beklenen format:** \`ProblemX_OGRENCI_NO.cs\` (9 haneli numara)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.run-tests.outputs.all_passed }}" = "true" ]; then
            echo "### âœ… TÃ¼m Testler BaÅŸarÄ±lÄ±!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Toplam Puan:** ${{ steps.run-tests.outputs.total_score }} / 100" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ‰ Tebrikler! PR merge edilebilir." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ BazÄ± Testler BaÅŸarÄ±sÄ±z" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Toplam Puan:** ${{ steps.run-tests.outputs.total_score }} / 100" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "DetaylÄ± test Ã§Ä±ktÄ±sÄ± iÃ§in yukarÄ±daki log'larÄ± inceleyin." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **PR merge edilemez.** TÃ¼m testlerin geÃ§mesi gerekiyor." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“š YardÄ±m iÃ§in: [GitHub Workshop Wiki](https://github.com/Furk4nBulut/Github-Workshop/wiki)" >> $GITHUB_STEP_SUMMARY

      - name: Post PR Comment
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ğŸ“Š C# Ã–dev Test SonuÃ§larÄ±
            
            ${{ steps.validate-files.outputs.valid == 'false' && '### âŒ Dosya AdÄ± HatasÄ±' || '' }}
            ${{ steps.validate-files.outputs.valid == 'false' && format('AÅŸaÄŸÄ±daki dosyalarÄ±n adlarÄ± yanlÄ±ÅŸ formatta:\n```\n{0}\n```\n\n**Beklenen format:** `ProblemX_OGRENCI_NO.cs` (9 haneli numara)', steps.validate-files.outputs.invalid_files) || '' }}
            
            ${{ steps.run-tests.outputs.all_passed == 'true' && '### âœ… TÃ¼m Testler BaÅŸarÄ±lÄ±!' || '' }}
            ${{ steps.run-tests.outputs.all_passed == 'true' && format('**Toplam Puan:** {0} / 100\n\nğŸ‰ Tebrikler! PR merge edilebilir.', steps.run-tests.outputs.total_score) || '' }}
            
            ${{ steps.run-tests.outputs.all_passed == 'false' && steps.validate-files.outputs.valid == 'true' && '### âš ï¸ BazÄ± Testler BaÅŸarÄ±sÄ±z' || '' }}
            ${{ steps.run-tests.outputs.all_passed == 'false' && steps.validate-files.outputs.valid == 'true' && format('**Toplam Puan:** {0} / 100\n\nDetaylÄ± test Ã§Ä±ktÄ±sÄ± iÃ§in [Actions loglarÄ±nÄ±]({1}) inceleyin.\n\nâŒ **PR merge edilemez.** TÃ¼m testlerin geÃ§mesi gerekiyor.', steps.run-tests.outputs.total_score, format('https://github.com/{0}/actions/runs/{1}', github.repository, github.run_id)) || '' }}
            
            ---
            
            <details>
            <summary>ğŸ“‹ Puanlama Sistemi</summary>
            
            | Problem | Konu | Max Puan |
            |---------|------|----------|
            | Problem 1 | Ã–ÄŸrenci Not Hesaplama (if-else) | 25 |
            | Problem 2 | GÃ¼n ve Ay Hesaplama (switch-case) | 25 |
            | Problem 3 | DÃ¶ngÃ¼ler ve Matematik | 25 |
            | Problem 4 | Dizi ve Liste Ä°ÅŸlemleri | 25 |
            | **TOPLAM** | | **100** |
            
            </details>
            
            ---
            ğŸ“š YardÄ±m iÃ§in: [GitHub Workshop Wiki](https://github.com/Furk4nBulut/Github-Workshop/wiki)

      - name: Check Test Results
        if: always() && steps.changed-files.outputs.any_changed == 'true'
        run: |
          if [ "${{ steps.validate-files.outputs.valid }}" = "false" ]; then
            echo "âŒ Dosya adÄ± formatÄ± yanlÄ±ÅŸ!"
            exit 1
          fi
          
          if [ "${{ steps.run-tests.outputs.all_passed }}" != "true" ]; then
            echo "âŒ BazÄ± testler baÅŸarÄ±sÄ±z!"
            exit 1
          fi
          
          echo "âœ… TÃ¼m kontroller baÅŸarÄ±lÄ±!"
